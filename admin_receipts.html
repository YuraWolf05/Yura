<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APEXIA Admin Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='admin_receipts.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}?v=1">
</head>
<body>
    <header>
        <h1>–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞ –ø–∞–Ω–µ–ª—å</h1>
    </header>
    <table>
        <thead>
            <tr>
                <th>–Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</th>
                <th>–¢–æ–≤–∞—Ä</th>
                <th>–¶—ñ–Ω–∞</th>
                <th>–ó–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ</th>
                <th>–ß–µ–∫</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î—ñ—ó</th>
            </tr>
        </thead>
        <tbody>
            {% for request in requests %}
            <tr>
                <td>{{ request.user_name }}</td>
                <td>{{ request.product_name }}</td>
                <td>{{ request.product_price }}</td>
                <td>{{ request.approved_by or '–ù–µ–º–∞—î' }}</td>
                <td>
                    {% if request.receipt_image != '–û—á—ñ–∫—É—î –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è' %}
                        <img src="{{ url_for('static', filename=request.receipt_image) }}" alt="–ß–µ–∫" style="width: 100px;">
                    {% else %}
                        <img src="{{ url_for('static', filename='default-placeholder.jpg') }}" alt="–û—á—ñ–∫—É—î—Ç—å—Å—è —á–µ–∫" style="width: 100px;">
                    {% endif %}
                </td>
                <td>{{ request.status }}</td>
                <td>
                    {% if request.status == 'pending' %}
                    <button onclick="handleRequest({{ request.id }}, 'approve')">–ó–∞—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
                    <button onclick="handleRequest({{ request.id }}, 'reject')">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
                    {% else %}
                    {{ request.status }}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <form action="/admin/grant_admin" method="POST">
        <label 
               style="margin-left: 15px;"
               for="username">–Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:</label>
        <input 
                style="margin-left: 10px;"
                type="text" id="username" name="username" required>
        <button type="submit">–ù–∞–¥–∞—Ç–∏ –ø—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</button>
        <button onclick="window.location.href='{{ url_for('profile') }}'">–í–∏–π—Ç–∏</button>
        <button onclick="window.location.href='{{ url_for('admin_users') }}'">Users</button>
    </form>
            <!-- –ö–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó —Ä–µ–∂–∏–º—É –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É -->
     <form id="activate-add-form" method="post" action="{{ url_for('activate_add_mode') }}">
         <button 
         style="color: rgb(255, 255, 255); background-color: rgb(53, 134, 13); font-size: 14px; padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; margin-top: 5px; margin-left: 5px;"
         type="submit">üîì –ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É</button>
     </form>
    
     <!-- –ö–Ω–æ–ø–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó -->
    <form id="deactivate-add-form" method="post" action="{{ url_for('deactivate_add_mode') }}">
        <button 
        style="color: rgb(255, 255, 255); background-color: rgb(53, 134, 13); font-size: 14px; padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; margin-top: 5px; margin-left: 5px;"
        type="submit">üîí –î–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏</button>
    </form>

    <script> 
            function handleRequest(requestId, action) {
            fetch(`/admin/approve_receipt/${requestId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: action })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(
                        action === 'approve' 
                        ? `–ó–∞—è–≤–∫—É –∑–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ! –ü—Ä–æ–º–æ-–∫–æ–¥: ${data.promo_code}` 
                        : '–ó–∞—è–≤–∫—É –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ.'
                    );
                    location.reload(); // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏
                } else {
                    alert(data.message || '–©–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫.');
                }
            })
            .catch(error => console.error('Fetch error:', error));
        }

        // –ê–∫—Ç–∏–≤–∞—Ü—ñ—è —Ä–µ–∂–∏–º—É –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É (—á–µ—Ä–µ–∑ Ajax)
        document.getElementById('deactivate-add-form').addEventListener('submit', function (e) {
        e.preventDefault();
        fetch('{{ url_for("deactivate_add_mode") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('üîí –†–µ–∂–∏–º –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É –¥–µ–∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ');
            } else {
                alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –¥–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏: ' + data.message);
            }
        });
    });
    document.getElementById('activate-add-form').addEventListener('submit', function (e) {
            e.preventDefault();
            fetch('{{ url_for("activate_add_mode") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ –†–µ–∂–∏–º –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ');
                } else {
                    alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏: ' + data.message);
                }
            });
        });
    </script>
</body>
</html>
